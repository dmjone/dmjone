<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <title>Admin Panel</title>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    </head>

    <body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="/">Admin Panel</a>
                <div class="collapse navbar-collapse">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a id="logout" class="nav-link" href="#">Logout</a></li>
                    </ul>
                </div>
            </div>
        </nav>
        <div class="container mt-4">
            <h1>Users</h1>
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Active</th>
                        <th>Created At</th>
                    </tr>
                </thead>
                <tbody id="users"></tbody>
            </table>
            <h2>Create New User</h2>
            <form id="createUserForm">
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" id="newUserEmail" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" id="newUserPassword" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Role</label>
                    <select id="newUserRole" class="form-select">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success">Create User</button>
            </form>
            <div id="createUserMessage" class="mt-3"></div>
            <h1 class="mt-5">Pending Articles</h1>
            <div id="pendingArticles" class="list-group"></div>
        </div>
        <script>
            document.getElementById('logout').addEventListener('click', e => {
                fetch('api/logout', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => {
                        window.location.href = '/'
                    })
            });
            fetch('api/admin/users').then(r => r.json()).then(data => {
                data.forEach(u => {
                    let row = document.createElement('tr');
                    row.innerHTML = '<td>' + u.id + '</td><td>' + u.email + '</td><td>' + u.role + '</td><td>' + (u.is_active ? 'Yes' : 'No') + '</td><td>' + u.created_at + '</td>';
                    document.getElementById('users').appendChild(row);
                });
            });
            document.getElementById('createUserForm').addEventListener('submit', e => {
                e.preventDefault();
                fetch('api/admin/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: document.getElementById('newUserEmail').value,
                        password: document.getElementById('newUserPassword').value,
                        role: document.getElementById('newUserRole').value
                    })
                }).then(r => r.json()).then(data => {
                    document.getElementById('createUserMessage').textContent = data.success ? "User created." : data.error;
                });
            });
            fetch('api/admin/articles').then(r => r.json()).then(data => {
                let pendingArticlesDiv = document.getElementById('pendingArticles');
                data.filter(a => a.status === 'pending').forEach(a => {
                    let item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center';
                    let titleSpan = document.createElement('span');
                    titleSpan.textContent = a.title;
                    let approveButton = document.createElement('button');
                    approveButton.className = 'btn btn-success btn-sm';
                    approveButton.textContent = 'Approve';
                    approveButton.addEventListener('click', e => {
                        e.preventDefault();
                        fetch('api/admin/articles/' + a.id + '/approve', { method: 'POST' })
                            .then(r => r.json())
                            .then(data => {
                                if (data.success) location.reload();
                                else alert(data.error);
                            });
                    });
                    item.appendChild(titleSpan);
                    item.appendChild(approveButton);
                    pendingArticlesDiv.appendChild(item);
                });
            });
        </script>
    </body>

</html>
<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <title>User Dashboard</title>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    </head>

    <body>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container">
                <a class="navbar-brand" href="/">Blog</a>
                <div class="collapse navbar-collapse">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a id="logout" class="nav-link" href="#">Logout</a></li>
                    </ul>
                </div>
            </div>
        </nav>
        <div class="container mt-4">
            <h1>Your Articles</h1>
            <div id="articles" class="list-group"></div>
            <button id="newArticle" class="btn btn-primary mt-3">New Article</button>
            <div id="articleForm" class="mt-4" style="display:none;">
                <h3 id="formTitle">New Article</h3>
                <form id="form">
                    <div class="mb-3"><input type="hidden" id="articleId"></div>
                    <div class="mb-3"><label class="form-label">Title</label><input type="text" id="title" class="form-control"></div>
                    <div class="mb-3"><label class="form-label">Slug</label><input type="text" id="slug" class="form-control"></div>
                    <div class="mb-3"><label class="form-label">Content</label><textarea id="content" class="form-control"></textarea></div>
                    <button type="submit" class="btn btn-success">Save</button>
                </form>
            </div>
        </div>
        <script>
            document.getElementById('logout').addEventListener('click', e => {
                fetch('api/logout', { method: 'POST' }).then(r => r.json()).then(data => {
                    window.location.href = '/'
                })
            })
            document.getElementById('newArticle').addEventListener('click', () => {
                document.getElementById('articleForm').style.display = 'block'
            })
            fetch('api/articles').then(r => r.json()).then(data => {
                data.filter(a => a.author_id).forEach(a => {
                    let item = document.createElement('a')
                    item.href = '#'
                    item.className = 'list-group-item list-group-item-action'
                    item.textContent = a.title + ' (' + a.status + ')'
                    item.onclick = () => {
                        document.getElementById('articleId').value = a.id
                        document.getElementById('title').value = a.title
                        document.getElementById('slug').value = a.slug
                        document.getElementById('content').value = a.content
                        document.getElementById('articleForm').style.display = 'block'
                    }
                    document.getElementById('articles').appendChild(item)
                })
            })
            document.getElementById('form').addEventListener('submit', e => {
                e.preventDefault()
                let id = document.getElementById('articleId').value
                let payload = { title: document.getElementById('title').value, slug: document.getElementById('slug').value, content: document.getElementById('content').value }
                if (id) {
                    fetch('api/articles/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }).then(r => r.json()).then(data => {
                        location.reload()
                    })
                } else {
                    fetch('api/articles', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }).then(r => r.json()).then(data => {
                        location.reload()
                    })
                }
            })
        </script>
    </body>

</html>
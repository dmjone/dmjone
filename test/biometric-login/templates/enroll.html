<!--
##############################################################################
# Biometric System HTML Templates
# 
# Authors:
#   Divya Mohan (Shoolini University | dmj.one)
#   Lakshika Tanwar (Shoolini University | National Quemoy University | dmj.one)
# Website: https://dmj.one
# Created on: November 16, 2024
# All Rights Reserved
#
# Description:
# These HTML templates are integral components of the Emotional State-based 
# Biometric Authentication System. They are designed to provide a user-friendly 
# and secure interface for enrollment, verification, and authentication processes.
#
# Copyright Notice:
# © 2024 Divya Mohan. All rights reserved. Unauthorized use, reproduction, 
# modification, distribution, or derivation of these templates or their designs 
# is strictly prohibited.
#
# Usage Restrictions:
# 1. Non-Commercial Use Only:
#    - These templates may only be used for educational or non-commercial research 
#      purposes with explicit written consent from Divya Mohan.
# 2. Prohibited Commercial Use:
#    - Commercial application, integration, or redistribution of these templates, 
#      in whole or in part, is strictly prohibited without prior written approval.
# 3. Prohibition of Derivative Works:
#    - No modifications, adaptations, or derivative works of these templates may 
#      be created without explicit written permission.
# 4. Exclusive Ownership:
#    - The designs, structures, and underlying styles of these templates are the 
#      exclusive property of Divya Mohan and are protected by intellectual property 
#      laws.
#
# Disclaimer:
# THESE TEMPLATES ARE PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, 
# INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR 
# PURPOSE, OR NONINFRINGEMENT. THE AUTHOR SHALL NOT BE LIABLE FOR ANY CLAIM, DAMAGES, OR 
# OTHER LIABILITY ARISING FROM THE USE OF THESE TEMPLATES.
#
# Enforcement:
# Any violation of the terms of this license will result in legal action to the fullest 
# extent of the law, including but not limited to damages, injunctions, and recovery of 
# costs and fees.
#
##############################################################################
-->


<!DOCTYPE html>
<html data-bs-theme="dark">

    <head>
        <title>Biometric Enrollment</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Include Bootstrap CSS -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
        <style>
            body {
                background: radial-gradient(circle, #141e30, #243b55);
                color: #fff;
                font-family: 'Arial', sans-serif;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                margin: 0;
            }

            .enroll-container {
                text-align: center;
                max-width: 400px;
                padding: 20px;
                background: rgba(0, 0, 0, 0.7);
                border-radius: 15px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            }

            #video {
                width: 150px;
                height: 150px;
                border: 2px solid #00d4ff;
                border-radius: 50%;
                object-fit: cover;
                margin: 20px auto;
                display: block;
                box-shadow: 0 0 15px #00d4ff;
            }

            .form-control {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid #00d4ff;
                color: #fff;
                font-size: 1rem;
                padding: 10px;
                border-radius: 5px;
            }

            .form-control:focus {
                background: rgba(255, 255, 255, 0.2);
                border-color: #00d4ff;
                box-shadow: 0 0 8px #00d4ff;
                color: #fff;
                outline: none;
            }

            .btn-primary {
                background: linear-gradient(to right, #00d4ff, #0084ff);
                border: none;
                color: #fff;
                font-size: 1.2rem;
                padding: 10px 20px;
                border-radius: 50px;
                transition: transform 0.3s ease, background 0.3s ease;
            }

            .btn-primary:hover {
                transform: scale(1.1);
                background: linear-gradient(to right, #0084ff, #00d4ff);
            }

            #message {
                margin-top: 20px;
                font-size: 1rem;
                color: #00d4ff;
            }

            /* Darker modal backdrop */
            .modal-backdrop {
                background-color: #000 !important;
                opacity: 0.7 !important;
                /* Dark and professional */
            }

            .modal-content {
                background: rgba(0, 0, 0, 0.85);
                color: #fff;
                border: 2px solid #00d4ff;
                border-radius: 10px;
            }

            /* Countdown circle container */
            .countdown-circle {
                width: 80px;
                height: 80px;
            }

            /* Countdown circle SVG animation */
            #countdownCircle {
                stroke: #ccc;
                /* Neutral, professional color */
                stroke-dasharray: 220;
                stroke-dashoffset: 220;
                animation: countdown-animation 5s linear forwards;
            }

            /* Countdown number styling */
            #countdownTimer {
                color: #ccc;
                font-size: 1.5rem;
            }

            /* Modal heading */
            .modal-body h5 {
                font-size: 1.2rem;
                color: #e0e0e0;
                /* Professional light gray */
                margin-bottom: 10px;
            }

            /* Modal body text */
            .modal-body p {
                font-size: 1rem;
                color: #b0b0b0;
                /* Subtle text color for readability */
                margin-bottom: 20px;
            }

            /* Countdown animation */
            @keyframes countdown-animation {
                from {
                    stroke-dashoffset: 220;
                }

                to {
                    stroke-dashoffset: 0;
                }
            }
        </style>
    </head>

    <body>

        <!-- Help Text for Biometric Enrollment -->
        <div id="help-text-container" class="mx-1 my-5" style="background: rgba(0, 0, 0, 0.9); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: #fff; font-size: 1rem; line-height: 1.6; text-align: justify !important;">
            <h3 style="color: #00d4ff; text-align: center; margin-bottom: 10px;">Enrollment Procedure</h3>
            <p style="margin-bottom: 15px; text-align: center;">Use your face, emotion, and voice as your key by following
                these quick steps:</p>
            <ol style="list-style-type: decimal; padding-left: 20px; font-size: 0.95rem;">
                <li><strong>Enter Your Name:</strong> Type your full name.</li>
                <li><strong>Choose an Emotion:</strong> Smile, stay calm, or show any emotion you like on your face.</li>
                <li><strong>Click "Enroll":</strong> The camera <strong>immediately</strong> takes your photo. Use the same
                    emotion to log in later.</li>
                <li><strong>Speak Freely:</strong> After a 5-second countdown, say anything you want, for example:
                    <i>“My voice is my password!”</i>
                </li>
                <li><strong>Wait:</strong> Your emotion, photo, and voice are encrypted and saved as your 1-click login
                    keys.</li>
            </ol>
            <p style="text-align: center; margin-top: 10px; font-size: 0.9rem;">Ready? Click below to begin!</p>
            <div style="text-align: center; margin-top: 15px;">
                <button id="acknowledge-button" class="btn btn-primary" style="padding: 10px 20px; font-size: 1rem;">Let’s Get Started</button>
            </div>
        </div>

        <div class="enroll-container d-none">
            <h1 class="mb-4">Enroll Biometric</h1>
            <input type="text" class="form-control mb-3 w-100" id="name" placeholder="Enter Your Full Name">
            <video id="video" autoplay muted loading="lazy"></video>
            <button id="enroll" class="btn btn-primary mt-4 w-100" aria-label="Enroll for biometric recording">Enroll</button>
            <div id="message"></div>
        </div>

        <!-- Pre-Recording Guide Modal -->
        <div class="modal fade" id="preRecordingModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content text-center p-3">
                    <div class="modal-body">
                        <div class="display-5 text-info">Photo Taken</div>
                        <p class="mt-3" style="color: #d4d4d4;">Now on next screen, speak any sentence loud and clear.</p>
                        <div class="mt-4" style="position: relative; display: flex; justify-content: center; align-items: center;">
                            <div class="countdown-circle">
                                <svg width="80" height="80" viewBox="0 0 80 80">
                                    <circle cx="40" cy="40" r="35" stroke="#00d4ff" stroke-width="5" fill="none" opacity="0.2" />
                                    <circle cx="40" cy="40" r="35" stroke="#00d4ff" stroke-width="5" fill="none" stroke-dasharray="220" stroke-dashoffset="220" id="countdownCircle" style="transition: stroke-dashoffset 1s linear;" />
                                </svg>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #00d4ff; font-size: 1.5rem;" id="countdownTimer">5</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recording Modal -->
        <div class="modal fade" id="recordingModal" tabindex="-1" aria-labelledby="recordingModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content text-center p-3">
                    <div class="modal-header mx-auto border-0">
                        <h3 class="modal-title display-2 text-warning" id="recordingModalLabel">Speak Now</h3>
                    </div>
                    <div class="modal-body">
                        <p>Please speak any sentence loud and clear.</p>
                        <!-- Recording Indicator -->
                        <div class="d-flex justify-content-center align-items-center mb-3">
                            <span class="me-2 text-danger fw-bold">●</span>
                            <span>Recording</span>
                        </div>
                        <!-- Spinner -->
                        <div class="spinner-border text-primary mx-auto" role="status">
                            <span class="visually-hidden">Recording...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Processing Overlay Modal -->
        <div class="modal fade" id="processingModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content text-center p-3">
                    <div class="modal-body">
                        <p class="my-3">Processing your enrollment. Please wait...</p>
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Processing...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

        <script>
            const enrollButton = document.getElementById('enroll');
            const acknowledgeButton = document.getElementById('acknowledge-button');
            const helpTextContainer = document.getElementById('help-text-container');
            const enrollContainer = document.querySelector('.enroll-container');            

            // Disable the Enroll button until the user acknowledges
            enrollButton.disabled = true;

            // Declare mediaStream variable
            let mediaStream;

            // Function to start the camera and microphone
            function startCamera() {
                // Access the user's webcam and microphone
                navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                    .then(stream => {
                        mediaStream = stream;
                        video.srcObject = stream;

                        // Prepare for audio recording
                        mediaRecorder = new MediaRecorder(stream);
                        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

                        mediaRecorder.onstop = () => {
                            const blob = new Blob(audioChunks, { type: 'audio/webm' });
                            const reader = new FileReader();
                            reader.readAsDataURL(blob);
                            reader.onloadend = () => {
                                voiceData = reader.result;
                                submitEnrollment();

                                // Stop audio tracks
                                if (mediaStream) {
                                    mediaStream.getAudioTracks().forEach(track => track.stop());
                                }
                            };
                        };
                    })
                    .catch(error => {
                        messageElement.innerHTML = '<div class="alert alert-danger" role="alert">Could not access camera and microphone. Please allow access.</div>';
                    });
            }

            // Enable the Enroll button when the user clicks Acknowledge
            acknowledgeButton.addEventListener('click', () => {
                enrollButton.disabled = false;
                enrollContainer.classList.toggle('d-none');
                helpTextContainer.style.display = 'none'; // Hide help text after acknowledgment
                startCamera();
            });

            const video = document.getElementById('video');
            const canvas = document.createElement('canvas'); // Hidden canvas for face image
            const messageElement = document.getElementById('message');
            let faceData = '';
            let voiceData = '';
            let mediaRecorder;
            let audioChunks = [];
            const audioDuration = 5000; // Record for 5 seconds

            // Reference to the processing modal
            const processingModal = new bootstrap.Modal(document.getElementById('processingModal'));
            const countdownTimerElement = document.getElementById('countdownTimer');
            const preRecordingModal = new bootstrap.Modal(document.getElementById('preRecordingModal'));
            const countdownCircle = document.getElementById('countdownCircle');

            document.getElementById('enroll').addEventListener('click', (event) => {
                event.target.disabled = true;

                const rawName = document.getElementById('name').value;
                const name = rawName.replace(/\s+/g, '').toLowerCase();

                if (!name) {
                    messageElement.innerHTML = '<div class="alert alert-danger" role="alert">Please enter your name.</div>';
                    event.target.disabled = false;
                    return;
                }

                // Capture face image
                canvas.width = 320;
                canvas.height = 240;
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                faceData = canvas.toDataURL('image/png');

                // Stop video tracks after capturing the photo
                if (mediaStream) {
                    mediaStream.getVideoTracks().forEach(track => track.stop());
                    video.classList.toggle('d-none');
                }

                // Show the pre-recording modal
                preRecordingModal.show();
                let countdown = 5;

                countdownTimerElement.textContent = countdown;
                countdownCircle.style.strokeDashoffset = '220';

                const countdownInterval = setInterval(() => {
                    countdown--;
                    countdownTimerElement.textContent = countdown;

                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        preRecordingModal.hide();

                        // Start audio recording
                        audioChunks = [];
                        mediaRecorder.start();

                        // Show recording modal
                        const recordingModal = new bootstrap.Modal(document.getElementById('recordingModal'));
                        recordingModal.show();

                        setTimeout(() => {
                            mediaRecorder.stop();
                            recordingModal.hide();
                        }, audioDuration);
                    }
                }, 1000);
            });

            // Show the processing modal before fetch
            function showProcessingModal() {
                processingModal.show();
            }

            // Hide the processing modal after fetch
            function hideProcessingModal() {
                processingModal.hide();
            }

            // Updated submitEnrollment to include processing modal
            function submitEnrollment() {
                    const rawName = document.getElementById('name').value;
                    const name = rawName.replace(/\s+/g, '').toLowerCase(); // Processed name
                    if (!faceData || !voiceData) {                        
                        messageElement.innerHTML = '<div class="alert alert-danger" role="alert">Error capturing data. Please try again.</div>';
                        document.getElementById('enroll').disabled = false;
                        return;
                    }

                    showProcessingModal(); // Show processing overlay

                    fetch('/enroll', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `username=${encodeURIComponent(name)}&face_data=${encodeURIComponent(faceData)}&voice_data=${encodeURIComponent(voiceData)}`
                    })
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(errData => {
                                    throw new Error(errData.message || 'Server error');
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            messageElement.innerHTML = `<div class="alert alert-success" role="alert">${data.message || 'Enrollment successful'}</div>`;                            
                        })
                        .catch(error => {                            
                            messageElement.innerHTML = `<div class="alert alert-danger" role="alert">Error: ${error.message}</div>`;
                        })
                        .finally(() => {
                            hideProcessingModal(); // Hide processing overlay

                            // Delink previous button actions and set new behavior
                            const enrollButton = document.getElementById('enroll');
                            enrollButton.disabled = false; // Re-enable the button
                            enrollButton.textContent = 'Go to Login';
                            enrollButton.id = 'verify'; // Change the ID to remove the old bindings
                            enrollButton.replaceWith(enrollButton.cloneNode(true)); // Ensure old events are removed

                            // Attach new click behavior to redirect to login
                            document.getElementById('verify').onclick = () => {
                                window.location.href = '/verify';
                            };
                        });
                }
        </script>        
    </body>

</html>
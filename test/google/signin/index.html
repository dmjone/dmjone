<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Google One Tap Sign-In</title>
        <script src="https://accounts.google.com/gsi/client" async defer></script>
    </head>

    <body>
        <script>
            (function () {
                // Inject HTML content
                document.body.innerHTML = `
            <div id="g_id_onload"
                data-client_id="107722137045-s1shk381lhpsu132999cl102kdlgs7c3.apps.googleusercontent.com"
                data-context="signin"
                data-ux_mode="popup"
                data-callback="handleCredentialResponse"
                data-auto_select="true"
                data-skip_prompt_cookie="sid"
                data-itp_support="true">
            </div>
            <div class="g_id_signin"
                data-type="standard"
                data-shape="pill"
                data-theme="outline"
                data-text="continue_with"
                data-size="large"
                data-logo_alignment="left">
            </div>        
            <div id="userData" style="margin-top: 20px;">
                <h2>User Data</h2>
                <pre id="userDataContent"></pre>
            </div>
            `;

                // Utility functions to handle cookies
                function setCookie(name, value, days) {
                    const expires = new Date(Date.now() + days * 864e5).toUTCString();
                    document.cookie = name + '=' + encodeURIComponent(value) + '; expires=' + expires + '; path=/';
                }

                function getCookie(name) {
                    return document.cookie.split('; ').reduce((r, v) => {
                        const parts = v.split('=');
                        return parts[0] === name ? decodeURIComponent(parts[1]) : r
                    }, '');
                }

                // Handle the response from Google One Tap Sign-In
                window.handleCredentialResponse = function (response) {
                    const userObject = JSON.parse(atob(response.credential.split('.')[1]));
                    console.log(userObject);
                    userObject.timestamp = Date.now();

                    // Save user data to local storage
                    localStorage.setItem('google_user', JSON.stringify(userObject));

                    // Set the sid cookie to prevent One Tap prompt
                    setCookie('sid', 'true', 7); // Cookie will expire in 7 days
                    window.location.reload();
                }

                // Check if login is required
                function checkLogin() {
                    const userData = localStorage.getItem('google_user');

                    if (userData) {
                        try {
                            const parsedUserData = JSON.parse(userData);
                            displayUserData(parsedUserData);
                        } catch (e) {
                            console.error('Failed to parse user data:', e);
                            localStorage.removeItem('google_user');
                            displaySignIn();
                            alert('Failed to parse user data. Please log in again.');
                        }
                    } else {
                        displaySignIn();
                    }
                }

                function displayUserData(userData) {
                    const userDataContent = document.getElementById('userDataContent');
                    userDataContent.textContent = JSON.stringify(userData, null, 2);
                }

                function displaySignIn() {
                    const signInDiv = document.getElementById('g_id_onload');
                    signInDiv.style.display = 'block';
                }

                document.addEventListener('DOMContentLoaded', checkLogin);
            })();
        </script>
    </body>

</html>